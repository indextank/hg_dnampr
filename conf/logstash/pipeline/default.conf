input {
  beats {
    port => 5044
  }
  
  # TCP 输入端口（可选）
  tcp {
    port => 5000
    codec => json_lines {
      # 设置解码大小限制为 20MB（解决警告）
      decode_size_limit_bytes => 20971520
    }
  }
  
  # HTTP 输入端口（可选）
  http {
    port => 8080
  }
}

filter {
  # 基本的日志处理
  if [fields][log_type] {
    mutate {
      add_tag => [ "%{[fields][log_type]}" ]
    }
  }
  
  # 处理时间戳
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
    }
  }
  
  # 移除不需要的字段（减少内存使用）
  mutate {
    remove_field => [ "host", "agent", "ecs" ]
  }
}

output {
  elasticsearch {
    # 使用完整URL（包含协议）
    hosts => ["${ELASTICSEARCH_PROTOCOL:http}://elasticsearch:9200"]
    index => "logstash-%{+YYYY.MM.dd}"
    # Elasticsearch认证配置（从环境变量读取）
    user => "${ELASTICSEARCH_USERNAME:elastic}"
    password => "${ELASTICSEARCH_PASSWORD}"
    # SSL配置（仅在使用HTTPS时启用）
    # 注意：当协议为http时，这些配置会被忽略
    # 使用新的参数名替代过时的cacert和ssl_certificate_verification
    ssl_certificate_authorities => ["${ELASTICSEARCH_SSL_CERTIFICATE_AUTHORITY:/usr/share/logstash/config/certs/ca/ca.crt}"]
    ssl_verification_mode => "full"
  }
  
  # 调试输出（开发时启用）
  # stdout { 
  #   codec => rubydebug 
  # }
} 